# Batch Image Generator Agent
# Generates 25-100 themed images from Leonardo.AI API
import logging
import requests
import time
import uuid
from datetime import datetime
from typing import Dict, List, Optional
import os

logger = logging.getLogger(__name__)

class BatchGeneratorAgent:
    """Agent for generating batches of themed images from Leonardo.AI"""
        
            def __init__(self):
                    self.api_key = os.getenv('LEONARDO_API_KEY')
                            self.base_url = "https://api.leonardo.ai/rest/v1"
                                    self.headers = {
                                                    'Authorization': f'Bearer {self.api_key}',
                                                                'Content-Type': 'application/json'
                                    }
                                            
                                                    # Theme templates with variations
                                                            self.theme_templates = {
                                                                            'nursery-animals': {
                                                                                                'subjects': ['bunny', 'deer', 'lamb', 'duckling', 'kitten', 'puppy', 'fox kit'],
                                                                                                                'styles': ['watercolor', 'illustration', 'soft painting', 'cute cartoon'],
                                                                                                                                'settings': ['forest', 'meadow', 'clouds', 'nature background'],
                                                                                                                                                'colors': ['sage green', 'soft pink', 'cream', 'pastel blue']
                                                                            },
                                                                                        'gothic-landscapes': {
                                                                                                            'subjects': ['castle', 'forest', 'mountains', 'lake', 'cliff', 'graveyard'],
                                                                                                                            'styles': ['dark painting', 'gothic art', 'oil painting', 'moody'],
                                                                                                                                            'settings': ['moonlight', 'storm', 'mist', 'twilight'],
                                                                                                                                                            'colors': ['deep purple', 'charcoal', 'blood red', 'silver']
                                                                                        },
                                                                                                    'abstract-modern': {
                                                                                                                        'subjects': ['geometric shapes', 'abstract patterns', 'flowing forms', 'color blocks'],
                                                                                                                                        'styles': ['minimalist', 'modern art', 'geometric', 'contemporary'],
                                                                                                                                                        'settings': ['clean background', 'gradient', 'solid color', 'pattern'],
                                                                                                                                                                        'colors': ['black', 'white', 'navy', 'gold', 'blush pink']
                                                                                                    },
                                                                                                                'botanical': {
                                                                                                                                    'subjects': ['flower', 'leaf', 'plant', 'branch', 'herb', 'fern', 'succulent'],
                                                                                                                                                    'styles': ['botanical illustration', 'scientific drawing', 'watercolor', 'engraving'],
                                                                                                                                                                    'settings': ['white background', 'aged paper', 'natural light'],
                                                                                                                                                                                    'colors': ['green', 'brown', 'cream', 'gold']
                                                                                                                },
                                                                                                                            'vintage-french': {
                                                                                                                                                'subjects': ['rose', 'peony', 'lavender', 'lily', 'floral arrangement', 'wreath'],
                                                                                                                                                                'styles': ['vintage poster', 'french art', 'decorative', 'romantic illustration'],
                                                                                                                                                                                'settings': ['ornate frame', 'aged background', 'damask pattern'],
                                                                                                                                                                                                'colors': ['rose pink', 'cream', 'gold', 'sage green']
                                                                                                                            }
                                                            }
                                                                
                                                                    def generate_prompt(self, theme: str, index: int) -> str:
                                                                            """Generate a unique prompt from theme templates"""
                                                                                    templates = self.theme_templates.get(theme, self.theme_templates['abstract-modern'])
                                                                                            
                                                                                                    subject = templates['subjects'][index % len(templates['subjects'])]
                                                                                                            style = templates['styles'][(index // len(templates['subjects'])) % len(templates['styles'])]
                                                                                                                    setting = templates['settings'][(index * 2 // len(templates['subjects'])) % len(templates['settings'])]
                                                                                                                            color = templates['colors'][(index * 3 // len(templates['subjects'])) % len(templates['colors'])]
                                                                                                                                    
                                                                                                                                            return f"{subject}, {style}, {setting}, {color} colors, professional quality, high resolution"
                                                                                                                                                
                                                                                                                                                    def generate_batch(self, theme: str, count: int) -> Dict:
                                                                                                                                                            """Generate a batch of themed images"""
                                                                                                                                                                    
                                                                                                                                                                            # Validate inputs
                                                                                                                                                                                    if count < 25 or count > 100:
                                                                                                                                                                                                return {
                                                                                                                                                                                                                    'status': 'failed',
                                                                                                                                                                                                                                    'error': 'Image count must be between 25 and 100',
                                                                                                                                                                                                                                                    'batch_id': None,
                                                                                                                                                                                                                                                                    'images_generated': 0
                                                                                                                                                                                                }
                                                                                                                                                                                                        
                                                                                                                                                                                                                if theme not in self.theme_templates:
                                                                                                                                                                                                                            available = ', '.join(self.theme_templates.keys())
                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                            'status': 'failed',
                                                                                                                                                                                                                                                                            'error': f'Theme "{theme}" not found. Available: {available}',
                                                                                                                                                                                                                                                                                            'batch_id': None,
                                                                                                                                                                                                                                                                                                            'images_generated': 0
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                        batch_id = f"batch_{int(time.time())}_{str(uuid.uuid4())[:8]}"
                                                                                                                                                                                                                                                                start_time = datetime.now()
                                                                                                                                                                                                                                                                        generated_images = []
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                        logger.info(f"Starting batch generation: {batch_id}, Theme: {theme}, Count: {count}")
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                        for i in range(count):
                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                    prompt = self.generate_prompt(theme, i)
                                                                                                                                                                                                                                                                                                                                                    logger.info(f"Generating image {i + 1}/{count}...")
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                    # Call Leonardo.AI API
                                                                                                                                                                                                                                                                                                                                                                                                    response = requests.post(
                                                                                                                                                                                                                                                                                                                                                                                                                            f"{self.base_url}/generations",
                                                                                                                                                                                                                                                                                                                                                                                                                                                json={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'prompt': prompt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'width': 1024,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'height': 1024,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'num_images': 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'quality': 'standard'
                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    headers=self.headers,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timeout=30
                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                    if response.status_code != 200:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.error(f"API error {response.status_code}: {response.text}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data = response.json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            generation_id = data.get('sdGenerationJob', {}).get('generationId')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not generation_id:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.error(f"No generation ID in response: {data}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Poll for image URL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    image_url = self._poll_for_image(generation_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if image_url:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generated_images.append({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'url': image_url,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'prompt': prompt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'theme': theme,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'order': i + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"✓ Image {i + 1}/{count} generated successfully")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.warning(f"✗ Image {i + 1}/{count} failed - timeout waiting for URL")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Rate limiting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(0.5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error(f"Error generating image {i + 1}/{count}: {str(e)}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            end_time = datetime.now()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    duration = (end_time - start_time).total_seconds()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info(f"✓ Batch generation complete: {len(generated_images)}/{count} images generated")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'status': 'success' if len(generated_images) > 0 else 'failed',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'batch_id': batch_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'theme': theme,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'images_generated': len(generated_images),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'total_count': count,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'images': generated_images,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'started_at': start_time.isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'completed_at': end_time.isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'duration_seconds': duration,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'error': None if len(generated_images) > 0 else 'No images were generated'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def _poll_for_image(self, generation_id: str, max_attempts: int = 30) -> Optional[str]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Poll Leonardo.AI API for generated image URL"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for attempt in range(max_attempts):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = requests.get(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f"{self.base_url}/generations/{generation_id}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    headers=self.headers,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timeout=10
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if response.status_code == 200:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data = response.json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                images = data.get('generations_by_pk', {}).get('generated_images', [])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if images and len(images) > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return images[0].get('url')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(0.5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error(f"Error polling for image: {str(e)}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            time.sleep(0.5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def get_batch_status(self, batch_id: str) -> Dict:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Get status of a batch generation (placeholder)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'batch_id': batch_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'status': 'unknown',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'message': 'Batch status tracking not yet implemented'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        })
                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                }
                                                                                                                            }
                                                                                                                }
                                                                                                    }
                                                                                        }
                                                                            }
                                                            }
                                    }